---
title: "Indicator Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include = FALSE}
library(tidyverse)
library(flexdashboard)
library(shiny)
library(nmfspalette)
library(lubridate)
library(here)
library(plotly)
library(viridis)
library(htmltools)
library(rmarkdown)
```

```{r, include = FALSE}
indicator_list <- c('Atmospheric Carbon Dioxide' = 'CO2',
                    'Oceanic pH' = 'pH',
                    'El Nino - Southern Oscillation' = 'ENSO',
                    'Pacific Decadal Oscillation' = 'PDO',
                    'Sea Surface Temperature' = 'SST',
                    'Temperature at Depth' = 'TatD',
                    'Ocean Color' = 'Chl', 
                    'Median Phytoplankton Size' = 'MD50')
```

```{r, include = FALSE, global = TRUE}
### Access indicator data
# This will need to be built out to include additional indicators.
# For now, just testing the framework.

indicator_data <- read_csv(here('Indicator_Dashboard','Dashboard_Data_2022.csv'))
```

```{r, include = FALSE, global = TRUE}
# Create color palette for easy reference 
oceans <- nmfs_palette("oceans")(3) # 1 = RptYr, 3 = previous years
crustacean <- nmfs_palette("crustacean")(4) # 1 = linear trend
coral <- nmfs_palette("coral")(3) # 3 = annual average for Rpt Yr
ann_grey <- "#D0D0D0" # annual means; in NMFS branding guide but not in package
waves <- nmfs_palette("waves")(3) # annual means; in NMFS branding guide but not in package
#pal <- c(oceans[3], oceans[1], ann_grey, coral[3], crustacean[1])
pal <- c(oceans[3], oceans[1], ann_grey, coral[3], crustacean[2]) #making some tweaks for visibility

```

Sidebar {.sidebar}
======================================================================
```{r}
# Select indicator to view
selectInput('indicator', label = 'Select an indicator', choices = indicator_list, selected = c('SST'))
```

The __Indicators at a Glance__ tab gives you a quick summary of all the available indicators.

The __Visualize Indicator__ tab provides a few data visualizations relevant to the indicator selected above.  

The __View Indicator Data__ tab lets you access the indicator time series data.

The __About the Indicator__ tab provides background information about the indicator along with some summary statistics.



This dashboard is designed to complement the Western Pacific Regional Fishery Management Council's [data portal](www.wpcouncildata.org/pelagicsafereport/), which includes the full suite of pelagic Climate and Oceanic Indicators and provides access to annual data.

Indicators at a Glance
======================================================================

```{r}
knitr::include_graphics(here("images", "Indicator-Table-2022-Monthly-Variables.png"))
```

Visualize Indicator {style="position:relative;" data-orientation=columns}
======================================================================

Column {style="height:100pc;"}
-----------------------------------------------------------------------

### Indicator Time Series

```{r}
output$ts <- renderPlotly({
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  # Calculate annual means
  ann_vals <- indicator_data |>
  group_by(Year) |>
  summarise(Value = mean(Value, na.rm = TRUE))

  p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value,
                type = "scatter", mode = "lines", line = list(color = pal[1]),
                name = ~ID[1]) |>
    add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value_lm,
              type = "scatter", mode = "lines", line = list(color = pal[5]),
              name = "Long-term Trend") |>
    add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Value,
              type = "scatter", mode = "lines", line = list(color = pal[3]),
              name = "Annual Mean") |>
    layout(yaxis = list(title = indicator_data$Units[1],
                        hoverformat = '.3f'),
           hovermode = "x unified", 
           hoverlabel = list(namelength = -1))
           # xaxis = list(title = " ", rangeslider = list(type = "date")))
  
  p1
})

plotlyOutput('ts')
```

### Anomaly Time Series

```{r}
output$anom_ts <- renderPlotly({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Calculate annual means
  ann_vals <- indicator_data |>
  group_by(Year) |>
  summarise(Anom = mean(Anom, na.rm = TRUE))

  
  p2 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom,
                type = "scatter", mode = "lines", line = list(color = pal[1]),
                name = "Monthly Anomaly") |>
    add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom_lm,
              type = "scatter", mode = "lines", line = list(color = pal[5]),
              name = "Long-term Trend") |>
    add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Anom,
              type = "scatter", mode = "lines", line = list(color = pal[3]),
              name = "Annual Mean") |>
    layout(yaxis = list(title = indicator_data$Units[1],
                        hoverformat = '.3f'),
           hovermode = "x unified", 
           hoverlabel = list(namelength = -1))#,
           # xaxis = list(title = " ", rangeslider = list(type = "date")))
  
  p2
})

plotlyOutput('anom_ts')
```

### Seasonal Cycle
```{r}
# Inspiration: Melanie's OceanWatch figure where each year is plotted individually
output$seasonal_cycle <- renderPlotly({

  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)

  #add month names
  Seasonal <- indicator_data |> group_by(Year) |> mutate("Month_Abb" =  month.abb)
  
  #add month order
  xform <- list(title = "", categoryorder = "array", categoryarray = month.abb)

  p3 <- plot_ly(Seasonal, x = ~Month_Abb, y = ~Value, 
                type = 'scatter', mode = 'markers', color = ~Year, text = ~ID[1],
                hovertemplate = paste('<b>%{text}</b>: %{y}',
                                      '<br><b>Year</b>: %{marker.color}',
                                      '<extra></extra>')) |>
    layout(yaxis = list(title = indicator_data$Units[1], hoverformat = '.3f'), xaxis = xform)
  
  p3

})

plotlyOutput('seasonal_cycle')
```

### Map

```{r}
#knitr::include_graphics(here("Sea_Surface_Temperature","SST_map_2022.png"))

#expects image to be in the format f.ex. ./images/SST_map_2022.png
output$map <- renderImage({

  # Select image
  filename = here('images', paste(input$indicator, '_map_2022.png', sep = ''))
  height <- session$clientData$output_map_height #dynamically adjust height 
  
  #Return a list containing filename and alt text
  list(src = filename,
       alt = "This is alternate text",
       height = height)

}, deleteFile = FALSE)

imageOutput("map")

```

View Indicator Data
======================================================================

Row {data-height=3}
-----------------------------------------------------------------------

### Indicator Time Series

```{r}
renderTable({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Value)
  
  # Rename the 'Value' column
  new_name <- paste(indicator_data$ID[1], 'in', indicator_data$Units[1], sep = ' ')
  # IndicatorTimeSeries <- rename(IndicatorTimeSeries, 
  #                               paste(indicator_data$ID[1], 'in', indicator_data$Units[1], sep = ' ') = Value)
  
  IndicatorTimeSeries
# },
#   
# downloadHandler(filename = function() {
#      paste(indicator_data$ID[1], 'in', indicator_data$Units[1], Sys.Date(), '.csv', sep = '')
#    },
#      content = function(file) {
#      write.csv(IndicatorTimeSeries, file, row.names = FALSE)
#    })

})
```

Row {data-height=1}
-----------------------------------------------------------------------

```{r}
# Create placeholder for the downloadButton
uiOutput("downloadUI")
```

```{r}
# Create the actual downloadButton
output$downloadUI <- renderUI( {
  downloadButton("downBtn", "Download time series data", style = paste("width: 220px;",
                                                                       "background-color:", pal[1], ";",
                                                                       "border-color:", pal[1], ";",
                                                                       "align: right;",
                                                                       "margin: 0px 0px 8px 0px;",
                                                                       sep =""))
})

# Add download handling
output$downBtn <- downloadHandler(
  filename = function() {
    
    indicator_data <- indicator_data %>% filter(ID == input$indicator) 
    paste(indicator_data$ID[1], 'in', str_remove(indicator_data$Units[1], " "), Sys.Date(), '.csv', sep = '_')
    
  },
  content = function(file_out) {
    
    #select indicator of interest and export only time and value
    data_for_dl <- indicator_data %>% 
      filter(ID == input$indicator) %>% 
      select(Date_Time, Value)
    
    write.csv(data_for_dl, file_out, row.names = FALSE)
})
```

Row {data-height=3}
-----------------------------------------------------------------------

### Anomaly Time Series

```{r}
renderTable({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Anom)
  
  IndicatorTimeSeries
})
```

Row {data-height=1}
-----------------------------------------------------------------------

```{r}
# Create placeholder for the downloadButton
uiOutput("downloadUIAnom")
```

```{r}
# Create the actual downloadButton
output$downloadUIAnom <- renderUI( {
  downloadButton("downBtnAnom", "Download anomaly data", style = paste("width: 220px;",
                                                                       "background-color:", pal[1], ";",
                                                                       "border-color:", pal[1], ";",
                                                                       "align: right;",
                                                                       "margin: 0px 0px 8px 0px;",
                                                                       sep =""))
})

# Add download handling
output$downBtnAnom <- downloadHandler(
  filename = function() {
    indicator_data <- indicator_data %>% filter(ID == input$indicator)
    paste(indicator_data$ID[1], 'in', str_remove(indicator_data$Units[1], " "), Sys.Date(), 'Anomaly.csv', sep = '_')
  },
  content = function(file_out) {
    
    #select indicator of interest and export only time and value
    data_for_dl <- indicator_data %>% 
      filter(ID == input$indicator) %>% 
      select(Date_Time, Anom)
    
    write.csv(data_for_dl, file_out, row.names = FALSE)
})
```

About the Indicator
======================================================================
```{r}
Indicator_Description <- reactive({
  indicator_desc <- indicator_data %>% filter(ID == input$indicator)
  # htmltools::includeMarkdown(here('Indicator_Dashboard',paste(indicator_data$ID[1], '_description.md', sep = '')))
  includeMarkdown(path = here('Indicator_Dashboard', paste(indicator_desc$ID[1], '_description.md', sep = '')))
})

renderUI({Indicator_Description()}) #renderUI needed here instead of renderText

# indicator_data <- indicator_data %>% filter(ID == input$indicator)
# Try htmltools::includeMarkdown('about.md')
# htmltools::includeMarkdown(here('Indicator_Dashboard','TestMarkdown.md'))
```
