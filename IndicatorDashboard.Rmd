---
title: "Indicator Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include = FALSE}
library(tidyverse)
library(flexdashboard)
library(shiny)
library(nmfspalette)
library(lubridate)
library(here)
library(plotly)
library(viridis)
library(htmltools)
```

```{r, include = FALSE}
indicator_list <- c('Atmospheric Carbon Dioxide' = 'CO2',
                    'Oceanic pH' = 'pH',
                    'El Nino - Southern Oscillation' = 'ENSO',
                    'Pacific Decadal Oscillation' = 'PDO',
                    'Sea Surface Temperature' = 'SST',
                    'Temperature at Depth' = 'TatD',
                    'Ocean Color' = 'Chl', 
                    'Median Phytoplankton Size' = 'MD50')
```

```{r, include = FALSE}
### Access indicator data
# This will need to be built out to include additional indicators.
# For now, just testing the framework.
indicator_data <- read_csv(here('Indicator_Dashboard','Dashboard_Data.csv'))
```

```{r, include = FALSE, global = TRUE}
# Create color palette for easy reference 
oceans <- nmfs_palette("oceans")(3) # 1 = RptYr, 3 = previous years
crustacean <- nmfs_palette("crustacean")(4) # 1 = linear trend
coral <- nmfs_palette("coral")(3) # 3 = annual average for Rpt Yr
ann_grey <- "#D0D0D0" # annual means; in NMFS branding guide but not in package
pal <- c(oceans[3], oceans[1], ann_grey, coral[3], crustacean[1])
```

Sidebar {.sidebar}
======================================================================
```{r}
# Select indicator to view
selectInput('indicator', label = 'Select an indicator', choices = indicator_list, selected = c('SST'))
```

The __Indicators at a Glance__ tab gives you a quick summary of all the available indicators.

The __Visualize Indicator__ tab provides a few data visualizations relevant to the indicator selected above.  

The __View Indicator Data__ tab lets you access the indicator time series data.

The __About the Indicator__ tab provides background information about the indicator along with some summary statistics.



This dashboard is designed to complement the Western Pacific Regional Fishery Management Council's [data portal](www.wpcouncildata.org/pelagicsafereport/), which includes the full suite of pelagic Climate and Oceanic Indicators and provides access to annual data.

Indicators at a Glance
======================================================================

```{r}
knitr::include_graphics(here("Indicator_Dashboard","Indicator-Table-2022-Monthly-Variables.png"))
```

Visualize Indicator
======================================================================

Row
-----------------------------------------------------------------------

### Indicator Time Series

```{r}
output$ts <- renderPlotly({
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  # Calculate annual means
  ann_vals <- indicator_data |>
  group_by(Year) |>
  summarise(Value = mean(Value, na.rm = TRUE))

  p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value,
                type = "scatter", mode = "lines", line = list(color = pal[1]),
                name = ~ID[1]) |>
    add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value_lm,
              type = "scatter", mode = "lines", line = list(color = pal[5]),
              name = "Long-term Trend") |>
    add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Value,
              type = "scatter", mode = "lines", line = list(color = pal[3]),
              name = "Annual Mean") |>
    layout(yaxis = list(title = indicator_data$Units[1])) # ,
           # xaxis = list(title = " ", rangeslider = list(type = "date")))
  
  p1
})

plotlyOutput('ts')
```

Row
-----------------------------------------------------------------------

### Anomaly Time Series

```{r}
output$anom_ts <- renderPlotly({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Calculate annual means
  ann_vals <- indicator_data |>
  group_by(Year) |>
  summarise(Anom = mean(Anom, na.rm = TRUE))

  
  p2 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom,
                type = "scatter", mode = "lines", line = list(color = pal[1]),
                name = "Monthly Anomaly") |>
    add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom_lm,
              type = "scatter", mode = "lines", line = list(color = pal[5]),
              name = "Long-term Trend") |>
    add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Anom,
              type = "scatter", mode = "lines", line = list(color = pal[3]),
              name = "Annual Mean") |>
    layout(yaxis = list(title = indicator_data$Units[1]))#,
           # xaxis = list(title = " ", rangeslider = list(type = "date")))
  
  p2
})

plotlyOutput('anom_ts')
```

Row
-----------------------------------------------------------------------

### Map

```{r}
knitr::include_graphics(here("Sea_Surface_Temperature","SST_map_2022.png"))
```

### Seasonal Cycle
```{r}
# Inspiration: Melanie's OceanWatch figure where each year is plotted individually
output$seasonal_cycle <- renderPlotly({

  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)

  Seasonal <- indicator_data |> group_by(Year)

  p3 <- plot_ly(Seasonal, x = ~Month, y = ~Value, 
                type = 'scatter', mode = 'markers', color = ~Year,
                name = ~ID[1]) |>
    layout(yaxis = list(title = indicator_data$Units[1]))
  
  p3

})

plotlyOutput('seasonal_cycle')
```

View Indicator Data
======================================================================

Row
-----------------------------------------------------------------------

### View Indicator Time Series

```{r}
renderTable({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Value)
  
  # Rename the 'Value' column
  new_name <- paste(indicator_data$ID[1], 'in', indicator_data$Units[1], sep = ' ')
  # IndicatorTimeSeries <- rename(IndicatorTimeSeries, 
  #                               paste(indicator_data$ID[1], 'in', indicator_data$Units[1], sep = ' ') = Value)
  
  IndicatorTimeSeries
# },
#   
# downloadHandler(filename = function() {
#      paste(indicator_data$ID[1], 'in', indicator_data$Units[1], Sys.Date(), '.csv', sep = '')
#    },
#      content = function(file) {
#      write.csv(IndicatorTimeSeries, file, row.names = FALSE)
#    })

})
```

### Download Indictor Time Series
```{r}
# https://shiny.posit.co/r/reference/shiny/1.0.4/downloadbutton
# https://stackoverflow.com/questions/55345498/downloadbutton-width-in-r-flexdashboard

# output$series_table <- downloadHandler({
#   
#   # Filter data
#   indicator_data <- indicator_data %>% filter(ID == input$indicator)
#   
#   # Just get the indicator columns
#   IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Value)
#   
#   filename = function() {
#     paste(indicator_data$ID[1], 'in', indicator_data$Units[1], Sys.Date(), '.csv', sep = '')
#   },
#   content = function(file_out) {
#     write.csv(IndicatorTimeSeries, file_out, row.names = FALSE)
#   }
#   
# })
# 
# downloadButton('series_table', 'Download Time Series')
```

```{r}
# Create placeholder for the downloadButton
# uiOutput("downloadUI")
```

```{r}
# Create the actual downloadButton
# output$downloadUI <- renderUI( {
#   downloadButton("series_table", "Download Time Series") # , style = "width:100%;")
#   
#   # Filter data
#   indicator_data <- indicator_data %>% filter(ID == input$indicator)
# 
#   # Just get the indicator columns
#   IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Value)
# })
# 
# # Add download handling
# output$series_table <- downloadHandler(
#   filename = function() {
#     paste(indicator_data$ID[1], 'in', indicator_data$Units[1], Sys.Date(), '.csv', sep = '')
#   },
#   content = function(file_out) {
#     write.csv(IndicatorTimeSeries, file_out, row.names = FALSE)
#   }
# )
```

Row
-----------------------------------------------------------------------

### Anomaly Time Series

```{r}
renderTable({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Anom)
  
  IndicatorTimeSeries
})
```

### Download Anomaly Time Series
```{r}
```

About the Indicator
======================================================================
```{r}
Indicator_Description <- reactive({
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  # htmltools::includeMarkdown(here('Indicator_Dashboard',paste(indicator_data$ID[1], '_description.md', sep = '')))
 includeMarkdown(here('Indicator_Dashboard',paste(indicator_data$ID[1], '_description.md', sep = '')))
})
renderText({Indicator_Description()})
  # indicator_data <- indicator_data %>% filter(ID == input$indicator)
# Try htmltools::includeMarkdown('about.md')
# htmltools::includeMarkdown(here('Indicator_Dashboard','TestMarkdown.md'))
```
