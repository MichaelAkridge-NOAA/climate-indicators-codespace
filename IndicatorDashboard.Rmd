---
title: "Indicator Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
resource_files:
  - "Indicator_Dashboard/Data/Dashboard_Data_2022.csv"
  - "Indicator_Dashboard/Images/Indicator-Table-2022-Monthly-Variables.png"
  - "Indicator_Dashboard/Images/SST_map_2022.png"
  - "Indicator_Dashboard/Images/TatD_map_2022.png"
  - "Indicator_Dashboard/Images/Chl_map_2022.png"
  - "Indicator_Dashboard/Images/MD50_map_2022.png"
  - "Indicator_Dashboard/Descriptions/SST_description.md"
---

```{r setup, include = FALSE}
library(tidyverse)
library(flexdashboard)
library(shiny)
library(nmfspalette)
library(lubridate)
library(here)
library(plotly)
library(viridis)
library(htmltools)
library(rmarkdown)
```

```{r, include = FALSE, global = TRUE}
indicator_list <- c('Atmospheric Carbon Dioxide' = 'CO2',
                    'Oceanic pH' = 'pH',
                    'El Ni単o - Southern Oscillation' = 'ENSO',
                    'Pacific Decadal Oscillation' = 'PDO',
                    'Sea Surface Temperature' = 'SST',
                    'Temperature at Depth' = 'TatD',
                    'Ocean Color' = 'Chl', 
                    'Median Phytoplankton Size' = 'MD50')

include_anom_list <- c("SST", "CO2", "Chl", "MD50")
exclude_ann_mean_list <- c("PDO", "ENSO")
```

```{r, include = FALSE, global = TRUE}
### Access indicator data
# This will need to be built out to include additional indicators.
# For now, just testing the framework.

indicator_data <- read_csv(here('Indicator_Dashboard','Data', 'Dashboard_Data_2022.csv'))
```

```{r, include = FALSE, global = TRUE}
# Create color palette for easy reference 
oceans <- nmfs_palette("oceans")(3) # 1 = RptYr, 3 = previous years
crustacean <- nmfs_palette("crustacean")(4) # 1 = linear trend
coral <- nmfs_palette("coral")(3) # 3 = annual average for Rpt Yr
ann_grey <- "#D0D0D0" # annual means; in NMFS branding guide but not in package
waves <- nmfs_palette("waves")(3) # annual means; in NMFS branding guide but not in package
#pal <- c(oceans[3], oceans[1], ann_grey, coral[3], crustacean[1])
pal <- c(oceans[3], oceans[1], waves[2], coral[3], crustacean[2]) #making some tweaks for visibility

```

Sidebar {.sidebar}
======================================================================
```{r}
# Select indicator to view
selectInput('indicator', label = 'Select an indicator', choices = indicator_list, selected = c('CO2'))

```

The __Indicators at a Glance__ tab gives you a quick summary of all the available indicators.

The __Visualize Indicator__ tab provides a few data visualizations relevant to the indicator selected above.  

The __View Indicator Data__ tab lets you access the indicator time series data.

The __About the Indicator__ tab provides background information about the indicator along with some summary statistics.



This dashboard is designed to complement the Western Pacific Regional Fishery Management Council's [data portal](www.wpcouncildata.org/pelagicsafereport/), which includes the full suite of pelagic Climate and Oceanic Indicators and provides access to annual data.

Indicators at a Glance {style="position:relative;" data-orientation=columns}
======================================================================

Column
-----------------------------------------------------------------------

```{r}

output$summary_img <- renderImage({
  
  # Select image
  filename = here('Indicator_Dashboard', 'Images', paste0(input$indicator, "-Indicator-Table-2022-Monthly-Variables.png"))
  height <- session$clientData$summary_img_height #dynamically adjust height 
  
  #Return a list containing filename and alt text
  list(src = filename,
       alt = "This is alternate text",
       width = "100%")

}, deleteFile = FALSE)

imageOutput("summary_img")

```

Visualize Indicator {style="position:relative;" data-orientation=columns}
======================================================================

Column {style="height:100pc;"}
-----------------------------------------------------------------------

### Indicator Time Series {style="min-height:350px"}

```{r}
output$ts <- renderPlotly({
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  if (input$indicator == "PDO"){
    
      indicator_data <- indicator_data |>
        mutate(Units = "Pacific Decal Oscillation (PDO)")
      
      #color-coded bar chart for PDO
      p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value, type = "bar",
                    name = ~ifelse(Value > 0, yes = "Positive PDO", no = "Negative PDO"),
                    color = ~Value > 0, colors = c(oceans[2], coral[2]))
      
  } else if (input$indicator == "ENSO"){
    
      #calculate pos/neg/neutral ENSO values 
      indicator_data <- indicator_data |> mutate(Sign = sign(Value)) |>
        mutate(Sign = ifelse(test = (Value < 0.5 & Value > -0.5), yes = 0, no = Sign)) |>
        group_by(Sign, Group = with(rle(Sign), rep(seq_along(lengths), lengths))) |>
        ungroup() |>
        add_count(Group) |>
        mutate(ENSO = "Neutral") |>
        mutate(Units = "Oceanic Ni単o Index (ONI)")
    
      #add ENSO category
      indicator_data[which(indicator_data$Sign == -1 & indicator_data$n >= 5),]$ENSO <- "La Ni単a"
      indicator_data[which(indicator_data$Sign == 1 & indicator_data$n >= 5),]$ENSO <- "El Ni単o"

      #color-coded bar chart for ENSO
      p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value, type = "bar",
                    name = ~ENSO, color = ~ENSO, colors = c(coral[2], oceans[2], ann_grey))
    
  }
  else{
      # all other indicators - line chart
      # Calculate annual means 
      ann_vals <- indicator_data |>
      group_by(Year) |>
      summarise(Value = mean(Value, na.rm = TRUE))
      
      p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value,
                type = "scatter", mode = "lines", line = list(color = pal[1]),
                name = ~ID[1]) |>
      add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value_lm,
               type = "scatter", mode = "lines", line = list(color = pal[5]),
               name = "Long-term Trend") |>
      add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Value,
               type = "scatter", mode = "lines", line = list(color = pal[3]),
               name = "Annual Mean")
  }

   #apply same layout for all plots
   p1 <- p1 |> layout(yaxis = list(title = indicator_data$Units[1],
                      hoverformat = '.3f'),
                      hovermode = "x unified", 
                      hoverlabel = list(namelength = -1))
  
  p1
}) %>% bindCache(input$indicator)

plotlyOutput('ts')
```

```{r results='asis'}

#TODO - how to make this conditional?? have tried a bunch of things and nothing has worked
cat("\n### Anomaly Time Series {style='min-height:350px'}\n")

```

```{r}

output$anom_ts <- renderPlotly({
  
  #only plot for certain variables
  if (input$indicator %in% include_anom_list){
  
      # Filter data
      indicator_data <- indicator_data %>% filter(ID == input$indicator)
      
      # Calculate annual means
      ann_vals <- indicator_data |>
      group_by(Year) |>
      summarise(Anom = mean(Anom, na.rm = TRUE))
    
      
      p2 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom,
                    type = "scatter", mode = "lines", line = list(color = pal[1]),
                    name = "Monthly Anomaly") |>
        add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom_lm,
                  type = "scatter", mode = "lines", line = list(color = pal[5]),
                  name = "Long-term Trend") |>
        add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Anom,
                  type = "scatter", mode = "lines", line = list(color = pal[3]),
                  name = "Annual Mean") |>
        layout(yaxis = list(title = indicator_data$Units[1],
                            hoverformat = '.3f'),
               hovermode = "x unified", 
               hoverlabel = list(namelength = -1))
      
      p2
  }
  
}) %>% bindCache(input$indicator)

plotlyOutput('anom_ts')
```

### Seasonal Cycle {style="min-height:350px"}

```{r warning = FALSE}

output$seasonal_cycle <- renderPlotly({
  
  #turn off uninformative plotly warning
  options(warn = -1)
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  #add month names and averages
  Seasonal <- indicator_data |> 
    mutate("Month_Abb" =  month.abb[Month]) |>
    group_by(Month) |>
    mutate(Mean_Val = mean(Value, na.rm = TRUE))
  
  p3_tmp <- Seasonal |>
    group_by(Month) |>
    group_map(~{plot_ly(.x, x = ~Year, y = ~Value, type = "scatter", color = ~Year, name = ~Month_Abb, 
                   colors = coral, mode = "markers+lines", line = list(color = pal[1], width = 1),
                   showlegend = FALSE) |>
         layout(yaxis = list(title = Seasonal$Units[1], hoverformat = '.3f'), 
                hovermode = "x unified", xaxis = list(title = ""), showlegend = TRUE) |>
         add_segments(x = min(Seasonal$Year), xend = max(Seasonal$Year), y = ~Mean_Val, yend = ~Mean_Val,
                line = list(color = "black", width = 2), name = "Monthly Mean", showlegend = (.y == 1)) |>
         colorbar(title = "Year", len = 0.7, x = 1, y = 0.8, limits = c(min(Seasonal$Year), max(Seasonal$Year)))}) |>
    subplot(nrows = 1, shareX = TRUE, shareY = TRUE, margin = 0.005)
  
  #add titles - better way to do this?
  p3_tmp$x$layout$xaxis$title <- "Jan"
  p3_tmp$x$layout$xaxis2$title <- "Feb"
  p3_tmp$x$layout$xaxis3$title <- "Mar"
  p3_tmp$x$layout$xaxis4$title <- "Apr"
  p3_tmp$x$layout$xaxis5$title <- "May"
  p3_tmp$x$layout$xaxis6$title <- "Jun"
  p3_tmp$x$layout$xaxis7$title <- "Jul"
  p3_tmp$x$layout$xaxis8$title <- "Aug"
  p3_tmp$x$layout$xaxis9$title <- "Sep"
  p3_tmp$x$layout$xaxis10$title <- "Oct"
  p3_tmp$x$layout$xaxis11$title <- "Nov"
  p3_tmp$x$layout$xaxis12$title <- "Dec"
  
  p3_tmp
  
}) %>% bindCache(input$indicator)

plotlyOutput('seasonal_cycle')

```

### Seasonal Points {style="min-height:350px"}

```{r}
# Inspiration: Melanie's OceanWatch figure where each year is plotted individually
output$seasonal_dots <- renderPlotly({

  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)

  #add month names
  Seasonal <- indicator_data |> group_by(Year) |> mutate("Month_Abb" =  month.abb[Month])
  
  #add month order
  xform <- list(title = "", categoryorder = "array", categoryarray = month.abb)

  p3 <- plot_ly(Seasonal, x = ~Month_Abb, y = ~Value, 
                type = 'scatter', mode = 'markers', color = ~Year, text = ~ID[1],
                hovertemplate = paste('<b>%{text}</b>: %{y}',
                                      '<br><b>Year</b>: %{marker.color}',
                                      '<extra></extra>')) |>
    layout(yaxis = list(title = indicator_data$Units[1], hoverformat = '.3f'), xaxis = xform)
  
  p3

}) %>% bindCache(input$indicator)

plotlyOutput('seasonal_dots')
```

### Map {style="min-height:400px"}

```{r}
#knitr::include_graphics(here("Sea_Surface_Temperature","SST_map_2022.png"))

#expects image to be in the format f.ex. ./images/SST_map_2022.png
output$map <- renderImage({

  # Select image
  filename = here('Indicator_Dashboard', 'Images',  paste(input$indicator, '_map_2022.png', sep = ''))
  height <- session$clientData$output_map_height #dynamically adjust height 
  
  #Return a list containing filename and alt text
  list(src = filename,
       alt = "This is alternate text",
       height = height)

}, deleteFile = FALSE)

imageOutput("map")

```

View Indicator Data
======================================================================

Row {data-height=3}
-----------------------------------------------------------------------

### Indicator Time Series

```{r}
renderTable({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Value)
  
  # Rename the 'Value' column
  new_name <- paste(indicator_data$ID[1], 'in', indicator_data$Units[1], sep = ' ')
  # IndicatorTimeSeries <- rename(IndicatorTimeSeries, 
  #                               paste(indicator_data$ID[1], 'in', indicator_data$Units[1], sep = ' ') = Value)
  
  IndicatorTimeSeries
# },
#   
# downloadHandler(filename = function() {
#      paste(indicator_data$ID[1], 'in', indicator_data$Units[1], Sys.Date(), '.csv', sep = '')
#    },
#      content = function(file) {
#      write.csv(IndicatorTimeSeries, file, row.names = FALSE)
#    })

})
```

Row {data-height=1}
-----------------------------------------------------------------------

```{r}
# Create placeholder for the downloadButton
uiOutput("downloadUI")
```

```{r}
# Create the actual downloadButton
output$downloadUI <- renderUI( {
  
  downloadButton("downBtn", "Download time series data", style = paste("width: 220px;",
                                                                       "background-color:", pal[1], ";",
                                                                       "border-color:", pal[1], ";",
                                                                       "align: right;",
                                                                       "margin: 0px 0px 8px 0px;",
                                                                       sep =""))
})

# Add download handling
output$downBtn <- downloadHandler(
  filename = function() {
    
    indicator_data <- indicator_data %>% filter(ID == input$indicator) 
    paste(indicator_data$ID[1], 'in', str_remove(indicator_data$Units[1], " "), Sys.Date(), '.csv', sep = '_')
    
  },
  content = function(file_out) {
    
    #select indicator of interest and export only time and value
    data_for_dl <- indicator_data %>% 
      filter(ID == input$indicator) %>% 
      select(Date_Time, Value)
    
    write.csv(data_for_dl, file_out, row.names = FALSE)
})
```

Row {data-height=3}
-----------------------------------------------------------------------

### Anomaly Time Series

```{r}
renderTable({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Anom)
  
  IndicatorTimeSeries
})
```

Row {data-height=1}
-----------------------------------------------------------------------

```{r}
# Create placeholder for the downloadButton
uiOutput("downloadUIAnom")
```

```{r}
# Create the actual downloadButton
output$downloadUIAnom <- renderUI( {
  
  downloadButton("downBtnAnom", "Download anomaly data", style = paste("width: 220px;",
                                                                       "background-color:", pal[1], ";",
                                                                       "border-color:", pal[1], ";",
                                                                       "align: right;",
                                                                       "margin: 0px 0px 8px 0px;",
                                                                       sep =""))
})

# Add download handling
output$downBtnAnom <- downloadHandler(
  filename = function() {
    indicator_data <- indicator_data %>% filter(ID == input$indicator)
    paste(indicator_data$ID[1], 'in', str_remove(indicator_data$Units[1], " "), Sys.Date(), 'Anomaly.csv', sep = '_')
  },
  content = function(file_out) {
    
    #select indicator of interest and export only time and value
    data_for_dl <- indicator_data %>% 
      filter(ID == input$indicator) %>% 
      select(Date_Time, Anom)
    
    write.csv(data_for_dl, file_out, row.names = FALSE)
})
```

About the Indicator
======================================================================
```{r}
Indicator_Description <- reactive({
  
  indicator_desc <- indicator_data %>% filter(ID == input$indicator)
  includeMarkdown(path = here('Indicator_Dashboard', 'Descriptions', paste(indicator_desc$ID[1], '_description.md', sep = '')))
})

renderUI({Indicator_Description()}) #renderUI needed here instead of renderText
```
