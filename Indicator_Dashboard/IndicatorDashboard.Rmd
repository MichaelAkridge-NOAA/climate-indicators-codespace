---
title: "Indicator Dashboard"
output: 
  flexdashboard::flex_dashboard:
    source_code: "https://github.com/pwoodworth-jefcoats/climate-indicators"
    orientation: rows
    vertical_layout: fill
    theme:
      version: 4
      bg: "#FFFFFF"
      fg: "#000000" 
      primary: "#005AA8"
      
runtime: shiny
resource_files:
  - "Data/Dashboard_Data_2022.csv"
  - "Data/Dashboard_Map_Data_2022.csv"
  - "Data/rnatearth_coast.RData"
  - "Data/rnatearth_land.RData"
  - "Images/Indicator-Table-2022-Monthly-Variables.png"
  - "Images/CO2-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/Chl-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/ENSO-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/MD50-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/PDO-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/SST-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/TatD-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/pH-Indicator-Table-2022-Monthly-Variables.png"
  - "Descriptions/CO2_description.md"
  - "Descriptions/pH_description.md"
  - "Descriptions/ENSO_description.md"
  - "Descriptions/PDO_description.md"
  - "Descriptions/SST_description.md"
  - "Descriptions/TatD_description.md"
  - "Descriptions/Chl_description.md"
  - "Descriptions/MD50_description.md"
---

```{r setup, include = FALSE}
library(tidyverse)
library(flexdashboard)
library(shiny)
library(nmfspalette)
library(lubridate)
library(here)
library(plotly)
library(viridis)
library(htmltools)
library(rmarkdown)
library(shinyjs)
library(DT)
library(scales)
library(sf)
```

```{r}
here::i_am("IndicatorDashboard.Rmd")
```

```{r, include = FALSE, global = TRUE}
indicator_list <- c('Atmospheric Carbon Dioxide' = 'CO2',
                    'Oceanic pH' = 'pH',
                    'El Ni単o - Southern Oscillation' = 'ENSO',
                    'Pacific Decadal Oscillation' = 'PDO',
                    'Sea Surface Temperature' = 'SST',
                    'Temperature at Depth' = 'TatD',
                    'Ocean Color' = 'Chl', 
                    'Median Phytoplankton Size' = 'MD50')

#set include/exclude lists
include_anom_list <- c("SST", "CO2", "Chl", "MD50") #indicators that have an anomaly plot
include_anom_map_list <- c("SST", "TatD", "Chl", "MD50") #indicators that have an anomaly map
report_year <- 2022 #current report year

#set formatting parameters
plot_title_font <- list(size = 14)
plot_height <- 350 #in pixels
table_height <- 300 #in pixels
plot_spacer_1 <- 20 #in pixels - space between bottom of plot and horizontal line
plot_spacer_2 <- 70 #in pixels - space between horizontal line and next plot

```

```{r, include = FALSE, global = TRUE}
### Access indicator data
indicator_data <- read_csv(here('Data', 'Dashboard_Data_2022.csv'))
indicator_map_data <- read_csv(here('Data', 'Dashboard_Map_Data_2022.csv'))

#Access map base data
land_proj <- readRDS(here('Data', 'rnatearth_land.RData'))
coast_proj <- readRDS(here('Data', 'rnatearth_coast.RData'))

```

```{r, include = FALSE, global = TRUE}

# Create color palette for easy reference 
oceans <- nmfs_palette("oceans")(3) # 1 = report_year, 3 = previous years
crustacean <- nmfs_palette("crustacean")(4) # 1 = linear trend
coral <- nmfs_palette("coral")(3) # 3 = annual average for Rpt Yr
ann_grey <- "#D0D0D0" # annual means; in NMFS branding guide but not in package
waves <- nmfs_palette("waves")(3) # annual means; in NMFS branding guide but not in package
seagrass <- nmfs_palette("seagrass")(3)
pal <- c(oceans[3], oceans[1], waves[2], coral[3], crustacean[2])

```

Sidebar {.sidebar}
======================================================================
<span style="color:#005AA8"><h4>__Select an indicator <br/>to begin:__</h4></span>
```{r}
# Select indicator to view - start with SST selected
div(style = "margin-top: -20px; ", #decreases amount of whitespace between label and input selection UI
  selectInput('indicator', label = ' ', choices = indicator_list, selected = c('SST'))
)

```

The __Indicators at a Glance__ tab gives you a quick summary of all the available indicators.

The __Visualize Indicator__ tab provides a few data visualizations relevant to the indicator selected above.  

The __View Indicator Data__ tab lets you access the indicator time series data.

The __About the Indicator__ tab provides background information about the indicator along with some summary statistics.

This dashboard is designed to complement the Western Pacific Regional Fishery Management Council's [data portal](www.wpcouncildata.org/pelagicsafereport/), which includes the full suite of pelagic Climate and Oceanic Indicators and provides access to annual data.

The dashboard data match the __`r report_year`__ pelagic SAFE report.  Dashboard data will be updated each summer following publication of the SAFE report.

Indicators at a Glance {style="position:relative;" data-orientation=columns}
======================================================================

Column
-----------------------------------------------------------------------

```{r}

#add summary image to output
output$summary_img <- renderImage({
  
  # Select image
  filename = here('Images', paste0(input$indicator, "-Indicator-Table-2022-Monthly-Variables.png"))

  #Return a list containing filename and alt text
  list(src = filename,
       alt = "This is alternate text",
       width = "100%")

}, deleteFile = FALSE)

#render summary image
imageOutput("summary_img")

```

Visualize Indicator {style="position:relative;" data-orientation=columns}
======================================================================

Column {style="margin-right: 5px;"}
-----------------------------------------------------------------------

```{r}

#build time series plot
output$ts <- renderPlotly({
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  if (input$indicator == "PDO"){ #PDO-specific plot
    
      indicator_data <- indicator_data |>
        mutate(Units = "Pacific Decal Oscillation (PDO)")
      
      #color-coded bar chart for PDO
      p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value, type = "bar", height = plot_height,
                    name = ~ifelse(Value > 0, yes = "Positive PDO", no = "Negative PDO"),
                    color = ~Value > 0, colors = c(oceans[2], coral[2]))
      
  } else if (input$indicator == "ENSO"){ #ENSO-specific plot
    
      #calculate pos/neg/neutral ENSO values 
      #needs to be greater than 0.5 or less than -0.5 for at least five consecutive seasons
      indicator_data <- indicator_data |> mutate(Sign = sign(Value)) |>
        mutate(Sign = ifelse(test = (Value < 0.5 & Value > -0.5), yes = 0, no = Sign)) |> #positive or negative?
        group_by(Sign, Group = with(rle(Sign), rep(seq_along(lengths), lengths))) |> #how many seasons in a row?
        ungroup() |>
        add_count(Group) |>
        mutate(ENSO = "Neutral") |>
        mutate(Units = "Oceanic Ni単o Index (ONI)")
    
      #add ENSO category
      indicator_data[which(indicator_data$Sign == -1 & indicator_data$n >= 5),]$ENSO <- "La Ni単a"
      indicator_data[which(indicator_data$Sign == 1 & indicator_data$n >= 5),]$ENSO <- "El Ni単o"

      #color-coded bar chart for ENSO
      p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value, type = "bar", height = plot_height, 
                    name = ~ENSO, color = ~ENSO, colors = c(coral[2], oceans[2], ann_grey))
    
  }
  else{ # all other indicators - line chart with annual mean and long-term trend (if included)
    
      # Calculate annual means 
      ann_vals <- indicator_data |>
        group_by(Year) |>
        summarise(Value = mean(Value, na.rm = TRUE))
      
      p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value,
                type = "scatter", mode = "lines", line = list(color = pal[1]),
                name = ~ID[1], height = plot_height) |>
      add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value_lm,
               type = "scatter", mode = "lines", line = list(color = pal[5]),
               name = "Long-term Trend") |>
      add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Value,
               type = "scatter", mode = "lines", line = list(color = pal[3]),
               name = "Annual Mean")
  }

   #apply same layout parameters for all plots
   p1 <- p1 |> layout(title = list(text = "Indicator Time Series", x = 0.01, font = plot_title_font), #add title
                      yaxis = list(title = indicator_data$Units[1], hoverformat = '.3f'), #add units and round values in hover display
                      paper_bgcolor='transparent', plot_bgcolor='transparent', #transparent background
                      hovermode = "x unified", #show data for all traces simultaneously
                      hoverlabel = list(namelength = -1)) #don't cutoff hoverinfo due to length
  
   #return plot
   p1
   
}) |> bindCache(input$indicator) #bind cache for faster subsequent renders

div(style = "margin-top: 10px; margin-bottom: -50px;", #adjust plot spacing
  #render time series plot
  plotlyOutput('ts')
)

#build time series plot descriptions
output$ts_desc <- renderUI( 
  
  #markdown('The __Time Series Plot__ shows monthly values for the indicator along with the annual average, or mean. For variables with a significant and steady (or linear) long-term trend, this is shown as well.')
  
  #indicator-specific descriptions for time series plot go here
  if (input$indicator == "CO2"){
    markdown("CO2 time series plot description")
  } else if (input$indicator == "SST"){
    markdown("SST time series plot description")
  } else if (input$indicator == "Chl"){
    markdown("Chl time series plot description")    
  } else if (input$indicator == "MD50"){
    markdown("MD50 time series plot description")    
  } else if (input$indicator == "ENSO"){
    markdown("ENSO time series plot description")
  } else if (input$indicator == "PDO"){
    markdown("PDO time series plot description")
  } else if (input$indicator == "pH"){
    markdown("pH time series plot description")
  } else if (input$indicator == "TatD"){
    markdown("TatD time series plot description")
  } 
)

div(style = paste0('color: #A5A5A5; margin-right: 15px; margin-left: 15px; margin-bottom: ', plot_spacer_1, 'px;'),
  uiOutput("ts_desc") #render time series plot descriptions
)

#add horizontal line
output$ts_divider <- renderUI(hr(style = paste0("border-top: 1px solid ", pal[1], "; margin-bottom: ", plot_spacer_2, "px")))
uiOutput("ts_divider")

```

```{r}

#build anomaly plot
output$anom_ts <- renderPlotly({
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  # Calculate annual means
  ann_vals <- indicator_data |>
  group_by(Year) |>
  summarise(Anom = mean(Anom, na.rm = TRUE))
  
  p2 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom, height = plot_height,
                type = "scatter", mode = "lines", line = list(color = pal[1]),
                name = "Monthly Anomaly") |>
    add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom_lm,
              type = "scatter", mode = "lines", line = list(color = pal[5]),
              name = "Long-term Trend") |>
    add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Anom,
              type = "scatter", mode = "lines", line = list(color = pal[3]),
              name = "Annual Mean") |>
    layout(yaxis = list(title = indicator_data$Units[1], hoverformat = '.3f'), #add units and round values in hover display
           title = list(text = "Anomaly Time Series", x = 0.01, font = plot_title_font), #add title 
           paper_bgcolor='transparent', plot_bgcolor='transparent', #transparent background
           hovermode = "x unified", #show data for all traces simultaneously
           hoverlabel = list(namelength = -1)) #don't cutoff hoverinfo due to length
  
  #return plot
  p2
  
}) |> bindCache(input$indicator) #bind cache for faster subsequent renders

useShinyjs(rmd = TRUE) #tell R we are going to use javascript in this chunk

#only show this plot for certain indicators
observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_list){
    shinyjs::showElement(id = 'anom_ts')
  } else{
    shinyjs::hideElement(id = 'anom_ts')
  }
})

#render anomaly plot
plotlyOutput('anom_ts')

#build anomaly plot descriptions
output$anom_desc <- renderUI(
  
  #markdown('The __Anomaly Time Series Plot__ shows the time series and annual average, or mean, with the seasonal cycle removed. For anomalies with a significant and steady (or linear) long-term trend, this is shown as well.')

  #indicator-specific descriptions for anomaly plot
  if (input$indicator == "CO2"){
    markdown("CO2 anomaly plot description")
  } else if (input$indicator == "SST"){
    markdown("SST anomaly plot description")
  } else if (input$indicator == "Chl"){
    markdown("Chl anomaly plot description")    
  } else if (input$indicator == "MD50"){
    markdown("MD50 anomaly plot description")    
  }
)

#only show these descriptions for certain indicators
observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_list){
    shinyjs::showElement(id = "anom_desc")
    shinyjs::showElement(id = "anom_divider")
  } else{
    shinyjs::hideElement(id = "anom_desc")
    shinyjs::hideElement(id = "anom_divider")
  }
})

div(style = paste0('color: #A5A5A5; margin-right: 15px; margin-left: 15px; margin-bottom: ', plot_spacer_1, 'px;'),
  uiOutput("anom_desc") #render anomaly plot descriptions
)

#add horizontal line
output$anom_divider <- renderUI(hr(style = paste0("border-top: 1px solid ", pal[1], "; margin-bottom: ", plot_spacer_2, "px")))
uiOutput("anom_divider")

```

```{r warning = FALSE}

#build seasonal cycle plot
output$seasonal_cycle <- renderPlotly({
  
  #turn off uninformative plotly warning
  options(warn = -1)
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  #add month names and averages
  Seasonal <- indicator_data |> 
    mutate("Month_Abb" =  month.abb[Month]) |>
    group_by(Month) |>
    mutate(Mean_Val = mean(Value, na.rm = TRUE))
  
  p3 <- Seasonal |>
    group_by(Month) |> #make separate subplots for each month
    group_map(~{plot_ly(.x, x = ~Year, y = ~Value, type = "scatter", color = ~Year, name = ~Month_Abb, height = plot_height,
                   colors = coral, mode = "markers+lines", line = list(color = pal[1], width = 1),
                   showlegend = FALSE) |>
         layout(yaxis = list(title = Seasonal$Units[1], hoverformat = '.3f'), 
                hovermode = "x unified", xaxis = list(title = ""), showlegend = TRUE) |>
         add_segments(x = min(Seasonal$Year), xend = max(Seasonal$Year), y = ~Mean_Val, yend = ~Mean_Val,
                line = list(color = "black", width = 2), name = "Monthly Mean", showlegend = (.y == 1)) |>
         colorbar(title = "Year", len = 0.7, x = 1, y = 0.8, limits = c(min(Seasonal$Year), max(Seasonal$Year)))}) |>
    subplot(nrows = 1, shareX = TRUE, shareY = TRUE, margin = 0.005) |> #add subplots
    layout(title = list(text = "Seasonal Cycle Plot", x = 0.01, font = plot_title_font), #add title
           paper_bgcolor='transparent', plot_bgcolor='transparent') #transparent background
  
  #add titles - can't find a better way to do this
  p3$x$layout$xaxis$title <- "Jan"
  p3$x$layout$xaxis2$title <- "Feb"
  p3$x$layout$xaxis3$title <- "Mar"
  p3$x$layout$xaxis4$title <- "Apr"
  p3$x$layout$xaxis5$title <- "May"
  p3$x$layout$xaxis6$title <- "Jun"
  p3$x$layout$xaxis7$title <- "Jul"
  p3$x$layout$xaxis8$title <- "Aug"
  p3$x$layout$xaxis9$title <- "Sep"
  p3$x$layout$xaxis10$title <- "Oct"
  p3$x$layout$xaxis11$title <- "Nov"
  p3$x$layout$xaxis12$title <- "Dec"
  
  #return plot
  p3
  
}) |> bindCache(input$indicator) #bind cache for faster subsequent renders

div(style = paste0("margin-bottom: ", plot_spacer_1, "px"),
  #render seasonal cycle plot
  plotlyOutput('seasonal_cycle')
)

#build seasonal cycle plot descriptions
output$season_desc <- renderUI(
  
  #markdown('The __Seasonal Plot__ shows the indicator values by month.  The cycle plot shows all the values for a given month in order by year. The points plot stacks them vertically.')
  
  #indicator-specific descriptions for seasonal plot
  if (input$indicator == "CO2"){
    markdown("CO2 seasonal plot description")
  } else if (input$indicator == "pH"){
    markdown("pH seasonal plot description")
  } else if (input$indicator == "ENSO"){
    markdown("ENSO seasonal plot description")
  } else if (input$indicator == "PDO"){
    markdown("PDO seasonal plot description")
  } else if (input$indicator == "SST"){
    markdown("SST seasonal plot description")
  } else if (input$indicator == "TatD"){
    markdown("TatD seasonal plot description")    
  } else if (input$indicator == "Chl"){
    markdown("Chl seasonal plot description")    
  } else if (input$indicator == "MD50"){
    markdown("MD50 seasonal plot description")    
  }
)

div(style = paste0('color: #A5A5A5; margin-right: 15px; margin-left: 15px; margin-bottom: ', plot_spacer_1, 'px;'),
  uiOutput("season_desc") #render seasonal cycle plot description
)

#add horizontal line
output$season_divider <- renderUI(hr(style = paste0("border-top: 1px solid ", pal[1], "; margin-bottom: ", plot_spacer_2, "px")))
uiOutput("season_divider")

```

```{r}
# Inspiration: Melanie's OceanWatch figure where each year is plotted individually
# not included for now
output$seasonal_dots <- renderPlotly({

  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)

  #add month names
  Seasonal <- indicator_data |> group_by(Year) |> mutate("Month_Abb" =  month.abb[Month])
  
  #add month order
  xform <- list(title = "", categoryorder = "array", categoryarray = month.abb)

  p3_tmp <- plot_ly(Seasonal, x = ~Month_Abb, y = ~Value, height = plot_height,
                type = 'scatter', mode = 'markers', color = ~Year, text = ~ID[1],
                hovertemplate = paste('<b>%{text}</b>: %{y}',
                                      '<br><b>Year</b>: %{marker.color}',
                                      '<extra></extra>')) |>
    layout(title = list(text = "Seasonal Points Plot", x = 0.01, font = plot_title_font), 
           paper_bgcolor='transparent',
           plot_bgcolor='transparent',
           yaxis = list(title = indicator_data$Units[1], hoverformat = '.3f'), xaxis = xform)
  
  #return plot
  p3_tmp

}) |> bindCache(input$indicator) #bind cache for faster subsequent renders

#uncomment line below to render dots plot
#if you decide to include it again, will need to add descriptions as above
#plotlyOutput('seasonal_dots')

```

```{r}

#build map
output$map <- renderPlotly({
  
  #filter plotting data
  raster_df <- indicator_map_data |> filter(ID == input$indicator) 
  
  #for indicators with spatial data 
  if (input$indicator %in% include_anom_map_list){
    
    #set color scheme and plotting parameters based on indicator
    if (input$indicator == "SST"){
      pal <- rev(waves)
      ll_rect_color <- "white" #outline for ll fishing grounds box
      fill_scale <- scale_fill_gradientn(name = input$indicator, colors = pal)
    } else if (input$indicator == "TatD"){
      pal <- rev(waves)
      ll_rect_color <- "white" #outline for ll fishing grounds box
      fill_scale <- scale_fill_gradientn(name = input$indicator, colors = pal)
    } else if (input$indicator == "Chl"){
      pal <- seagrass
      ll_rect_color <- "white" #outline for ll fishing grounds box
      fill_scale <- scale_fill_gradientn(name = input$indicator, trans = log10_trans(),  
                                         colors = pal, limits = c(0.01, 10), oob = squish) #log scale
    } else if (input$indicator == "MD50"){
      pal <- seagrass
      ll_rect_color <- "black" #outline for ll fishing grounds box
      fill_scale <- scale_fill_gradientn(name = input$indicator, colors = pal)
    }
    
    #report year map
    #first build in ggplot
    p <- ggplot() + 
      geom_raster(data = raster_df, mapping = aes(x=x, y=y, fill=layer, text = labels)) + #data as raster
      geom_rect(aes(xmin = 0, xmax = 60, ymin = 15, ymax = 45), color = ll_rect_color, fill = NA, linewidth = 0.5)  + #ll fishing grounds box
      annotate("text", x = 30, y = 47, label = "Longline fishing grounds", size = 3.2, color = ll_rect_color) +
      fill_scale + #indicator-dependent color and scale from above
      geom_sf(data = land_proj, fill = "#A5A5A5", color = "#A5A5A5", linewidth = 0.5) + #base map background
      geom_sf(data = coast_proj) + #base map outline
      coord_sf(expand = F) + #don't expand past x/y limits
      xlab("") + ylab("") + 
      theme_bw() + theme(panel.grid = element_line(color="black", linewidth = 0.1),
                         legend.background = element_rect(fill='transparent'))
    
    #next port to plotly
    g <- ggplotly(p, tooltip = c("labels"), height = plot_height) |>
      layout(paper_bgcolor = 'transparent', plot_bgcolor = 'transparent') |>
      style(hoverinfo = "skip", traces = c(3, 4)) #don't show hoverinfo for longline fishing grounds box/label
    
    #return plot
    g
    
  } else{ #indicators without spatial data (CO2, pH, ENSO, PDO)
    
    ext <- st_bbox(land_proj)
    
    #make base map
    p <- ggplot() + 
      geom_rect(aes(xmin = ext$xmin, xmax = ext$xmax, ymin = ext$ymin, ymax = ext$ymax), #rectangle for coloring ocean
                color = NA, fill = oceans[1])  +
      geom_rect(aes(xmin = 0, xmax = 60, ymin = 15, ymax = 45), color = "black", fill = NA, linewidth = 0.5) + #ll fishing grounds box
      annotate("text", x = 30, y = 47, label = "Longline fishing grounds", size = 3.2, color = "black") +
      geom_vline(xintercept = c(0, 60), color="black", linewidth = 0.1) + #manually add graticules (hidden by ocean rectangle)
      geom_hline(yintercept = seq(0, 60, 10), color="black", linewidth = 0.1) +
      xlab("") + ylab("") +
      theme_bw()
    
    #add data based on indicator
    if (input$indicator == "CO2"){
      
      #show Mauna Loa Observatory location
      p <- p +       
        geom_sf(data = land_proj, fill = "#A5A5A5", color = "#A5A5A5", linewidth = 0.5) +
        geom_sf(data = coast_proj, color = "black", linewidth = 0.5) +
        coord_sf(xlim = c(ext$xmin, ext$xmax), ylim = c(ext$ymin, ext$ymax), expand = F) +
        annotate(geom = "point", x = 24.4, y = 19.5, color = crustacean[2]) +
        annotate(geom = "text", x = 33.5, y = 19.5, color = "black", size = 3.2,
                 label = "Mauna Loa\nObservatory")
      
      #port to plotly
      g <- ggplotly(p, height = plot_height) |> 
        layout(paper_bgcolor = 'transparent', plot_bgcolor = 'transparent',
               xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE)) |>
        style(hoverinfo = "skip", traces = c(1:8, 10))
    
      #customize tooltip
      g$x$data[[9]]$text <- "155.6W, 19.5N<br />Mauna Loa Observatory"
      
      #return plot
      g
      
    } else if (input$indicator == "pH"){
      
      #show station ALOHA location
      p <- p + 
        geom_sf(data = land_proj, fill = "#A5A5A5", color = "#A5A5A5", linewidth = 0.5) +
        geom_sf(data = coast_proj, color = "black", linewidth = 0.5) +
        coord_sf(xlim = c(ext$xmin, ext$xmax), ylim = c(ext$ymin, ext$ymax), expand = F) +
        annotate(geom = "point", x = 22.0, y = 22.75, color = crustacean[2]) +
        annotate(geom = "text", x = 22.0, y = 26.5, color = "black", size = 3.2,
                 label = "Station\nALOHA")
      
      #port to plotly
      g <- ggplotly(p, height = plot_height) |>
        layout(paper_bgcolor = 'transparent', plot_bgcolor = 'transparent',
               xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE)) |>
        style(hoverinfo = "skip", traces = c(1:8, 10))
    
      #customize tooltip
      g$x$data[[9]]$text <- "158.0W, 22.75N<br />Station ALOHA"
      
      #return plot
      g
            
    } else if (input$indicator == "ENSO"){
      
      #show ENSO calculation region
      p <- p + 
        geom_rect(aes(xmin = 60, xmax = 10, ymin = -5, ymax = 5), 
                         color = crustacean[3], fill = crustacean[2], 
                         alpha = 0.5, linewidth = 0.5) +
        geom_sf(data = land_proj, fill = "#A5A5A5", color = "#A5A5A5", linewidth = 0.5) +
        geom_sf(data = coast_proj, color = "black", linewidth = 0.5) +
        coord_sf(xlim = c(ext$xmin, ext$xmax), ylim = c(ext$ymin, ext$ymax), expand = F) +
        annotate("text", x = 35, y = 7, label = "Ni単o 3.4 Region", size = 3.2, color = "black")
      
      #port to plotly
      g <- ggplotly(p, height = plot_height) |>
        layout(paper_bgcolor = 'transparent', plot_bgcolor = 'transparent',
               xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE)) |>
        style(hoverinfo = "skip", traces = c(1:6, 8:10))
            
      #customize tooltip
      g$x$data[[7]]$text <- "120.0W to 170.0W<br />5.0S to 5.0N<br />Ni単o 3.4 Region"
      
      #return plot
      g
      
    } else if (input$indicator == "PDO"){
      
      #show PDO calculation region
      p <- p + 
        geom_rect(aes(xmin = ext$xmin, xmax = ext$xmax, ymin = 20, ymax = ext$ymax), 
                         color = crustacean[3], fill = crustacean[2], 
                         alpha = 0.5, linewidth = 0.5) +
        geom_sf(data = land_proj, fill = "#A5A5A5", color = "#A5A5A5", linewidth = 0.5) +
        geom_sf(data = coast_proj, color = "black", linewidth = 0.5) +
        coord_sf(xlim = c(ext$xmin, ext$xmax), ylim = c(ext$ymin, ext$ymax), expand = F) +
        annotate("text", x = 160, y = 22, 
                 label = "PDO Region", size = 3.2, color = "black")
      
      #port to plotly
      g <- ggplotly(p, height = plot_height) |> 
        layout(paper_bgcolor = 'transparent', plot_bgcolor = 'transparent',
               xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE)) |>
        style(hoverinfo = "skip", traces = c(1:6, 8:10))
            
      #customize tooltip
      g$x$data[[7]]$text <- "Pacific basin above 20N<br />PDO Region"
      
      #return plot
      g
      
    }
  }
    
}) |> bindCache(input$indicator) #bind cache for faster subsequent renders

plotlyOutput('map') #render map

#build map descriptions
output$map_desc <- renderUI( 
  #markdown('This __Map__ shows the climatological average for this variable.  The data in the graphs above is averaged over the longline fishing grounds as indicated on this map.')
  
  #indicator-specific descriptions for map
  if (input$indicator == "CO2"){
    markdown("CO2 map description")
  } else if (input$indicator == "pH"){
    markdown("pH map description")
  } else if (input$indicator == "ENSO"){
    markdown("ENSO map description")
  } else if (input$indicator == "PDO"){
    markdown("PDO map description")
  } else if (input$indicator == "SST"){
    markdown("SST map description")
  } else if (input$indicator == "TatD"){
    markdown("TatD map description")    
  } else if (input$indicator == "Chl"){
    markdown("Chl map description")    
  } else if (input$indicator == "MD50"){
    markdown("MD50 map description")    
  }  
)

div(style = paste0('color: #A5A5A5; margin-right: 15px; margin-left: 15px; margin-bottom: ', plot_spacer_1, 'px;'),
  #render map
  uiOutput("map_desc")
)

```

```{r}

#build anomaly map
output$anom_map <- renderPlotly({
  
  #filter plotting data
  raster_anom_df <- indicator_map_data |> filter(ID == paste0(input$indicator, "_anom")) 

  #set different scale for chlorophyll to ignore high outliers - mostly in lakes in NA, so not relevant
  if (input$indicator == "Chl"){
    anom_fill_scale <- scale_fill_gradient2(name = input$indicator, low = oceans[2], 
                                            mid = "white", high = coral[2], oob = squish, 
                                            midpoint = 0, limits = c(-1, 1))
  } else{
    anom_fill_scale <- scale_fill_gradient2(name = input$indicator, low = oceans[2], 
                                            mid = "white", high = coral[2], midpoint = 0)
  }

  
  #report year map
  #first build in ggplot
  p_anom <- ggplot() + 
    geom_raster(data = raster_anom_df, mapping = aes(x=x, y=y, fill=layer, text = labels)) +
    geom_rect(aes(xmin = 0, xmax = 60, ymin = 15, ymax = 45), color = "black", fill = NA, linewidth = 0.5)  +
    annotate("text", x = 30, y = 47, label = "Longline fishing grounds", size = 3.2, color = "black") +
    anom_fill_scale +
    geom_sf(data = land_proj, fill = "#A5A5A5", color = "#A5A5A5", linewidth = 0.5) +
    geom_sf(data = coast_proj) +
    coord_sf(expand = F) +
    xlab("") + ylab("") +
    theme_bw() + theme(panel.grid = element_line(color="black", linewidth = 0.1),
                       legend.background = element_rect(fill='transparent'))
  
  #next, port to plotly
  g_anom <- ggplotly(p_anom, tooltip = c("labels"), height = plot_height) |>
            layout(paper_bgcolor = 'transparent', plot_bgcolor = 'transparent') |>
            style(hoverinfo = "skip", traces = c(3, 4))
  
  #return map
  g_anom
    
}) |> bindCache(input$indicator) #bind cache for faster subsequent renders

#tell R we're using javascript in this code chunk
useShinyjs(rmd = TRUE)

#only show anomaly map for certain indicators
observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_map_list){
    shinyjs::showElement(id = "anom_map")
    shinyjs::showElement(id = "anom_map_desc")
  } else{
    shinyjs::hideElement(id = "anom_map")
    shinyjs::hideElement(id = "anom_map_desc")
  }
})

#render anaomaly map
plotlyOutput('anom_map')

#build anomaly map descriptions
output$anom_map_desc <- renderUI(
  
  #markdown('This __Anomaly Map__ shows the difference between the latest full year and the climatological average.  Positive values show that the indicator is greater than averarage in that location and negative values show that is lower than average.')
  
  #indicator-specific descriptions for seasonal plot
  if (input$indicator == "SST"){
    markdown("SST map description")
  } else if (input$indicator == "TatD"){
    markdown("TatD map description")    
  } else if (input$indicator == "Chl"){
    markdown("Chl map description")    
  } else if (input$indicator == "MD50"){
    markdown("MD50 map description")    
  }  
  
)

div(style = paste0('color: #A5A5A5; margin-right: 15px; margin-left: 15px; margin-bottom: 10px;'),
  #render anomaly map description
  uiOutput("anom_map_desc")
)

```

View Indicator Data
======================================================================

Row
-----------------------------------------------------------------------

```{r}
#build time series data table
output$time_series_table <- renderDT({
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data |> select(Date_Time, Value)
  
  # Rename the 'Value' column
  new_name <- paste(indicator_data$ID[1], 'in', indicator_data$Units[1], sep = ' ')
  names(IndicatorTimeSeries)[2] <- new_name

  IndicatorTimeSeries}, 
  selection = 'none',
  caption = htmltools::tags$caption(style = 'color:black; caption-side: top;', "Indicator Time Series Data:"),
  options = list(searching = FALSE, paging = TRUE, info = FALSE, lengthChange = FALSE, #set formatting options for table
                 columnDefs = list(list(className = 'dt-right', targets = c(0, 1)))),
  rownames = FALSE
  
)

#render time series data table
DTOutput("time_series_table", width = "90%", height = table_height)

```

Row
-----------------------------------------------------------------------

```{r}
#build time series data download button
output$downloadUI <- renderUI( {
  
  downloadButton("downBtn", "Download time series data", style = paste("width: 220px;",
                                                                       "background-color:", pal[1], ";",
                                                                       "border-color:", pal[1], ";",
                                                                       "align: right;",
                                                                       "margin: 0px 0px 8px 0px;",
                                                                       sep =""))
})

#add download handling
output$downBtn <- downloadHandler(
  filename = function() {
    
    indicator_data <- indicator_data |> filter(ID == input$indicator) 
    paste(indicator_data$ID[1], 'in', str_remove(indicator_data$Units[1], " "), Sys.Date(), '.csv', sep = '_')
    
  },
  content = function(file_out) {
    
    #select indicator of interest and export only time and value
    data_for_dl <- indicator_data |>
      filter(ID == input$indicator) |> 
      select(Date_Time, Value)
    
    write.csv(data_for_dl, file_out, row.names = FALSE)
})

#render download button
uiOutput("downloadUI")

```

Row 
-----------------------------------------------------------------------

```{r}

#build anomaly data table
output$anom_table <- renderDT({
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data |> select(Date_Time, Anom)
  
  IndicatorTimeSeries}, 
  selection = 'none',
  caption = htmltools::tags$caption(style = 'color:black; caption-side: top;', "Anomaly Time Series Data:"),
  options = list(searching = FALSE, paging = TRUE, info = FALSE, lengthChange = FALSE,
                 columnDefs = list(list(className = 'dt-right', targets = c(0, 1)))),
  rownames = FALSE
  
)

#tell R we're using javascript in this code chunk
useShinyjs(rmd = TRUE)

#only show anomaly table for certain indicators
observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_list){
    shinyjs::showElement(id = "anom_table")
  } else{
    shinyjs::hideElement(id = "anom_table")
  }
})

#render anomaly data table
DTOutput("anom_table", width = "90%", height = table_height)

```

Row 
-----------------------------------------------------------------------

```{r}
#build anomaly data download button
output$downloadUIAnom <- renderUI( {
  
  downloadButton("downBtnAnom", "Download anomaly data", style = paste("width: 220px;",
                                                                       "background-color:", pal[1], ";",
                                                                       "border-color:", pal[1], ";",
                                                                       "align: right;",
                                                                       "margin: 0px 0px 8px 0px;",
                                                                       sep =""))
})

# Add download handling
output$downBtnAnom <- downloadHandler(
  filename = function() {
    indicator_data <- indicator_data |> filter(ID == input$indicator)
    paste(indicator_data$ID[1], 'in', str_remove(indicator_data$Units[1], " "), Sys.Date(), 'Anomaly.csv', sep = '_')
  },
  content = function(file_out) {
    
    #select indicator of interest and export only time and value
    data_for_dl <- indicator_data |> 
      filter(ID == input$indicator) |> 
      select(Date_Time, Anom)
    
    write.csv(data_for_dl, file_out, row.names = FALSE)
})

#tell R we're using javascript in this code chunk
useShinyjs(rmd = TRUE)

#only show anomaly downlaod button for certain indicators
observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_list){
    shinyjs::showElement(id = "downloadUIAnom")
  } else{
    shinyjs::hideElement(id = "downloadUIAnom")
  }
})

##render anomaly data download button
uiOutput("downloadUIAnom")

```

About the Indicator
======================================================================

Row
-----------------------------------------------------------------------

### Annual Average

```{r}

#build and render value box - annual mean for report year
renderValueBox({
  
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  # Annual mean for report year
  if (input$indicator == "pH"){
    #pH year data is one behind report year
    ann_mean_report_year <- indicator_data |> filter(Year == report_year - 1) |>
    summarise(Value = mean(Value, na.rm = TRUE)) |> signif(3)
    tmp_caption <- paste(as.character(report_year - 1), "Average")
  } else{
    #for all other indicators, use report year
    ann_mean_report_year <- indicator_data |> filter(Year == report_year) |>
    summarise(Value = mean(Value, na.rm = TRUE)) |> signif(3) 
    tmp_caption <- paste(as.character(report_year), "Average")
  }
  
  valueBox(value = ann_mean_report_year, color = pal[1], caption = tmp_caption)
})
```

### Annual Range

```{r}

#build and render value box - annual range for report year
renderValueBox({
  
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  # Monthly min & max for report year
  if (input$indicator == "pH"){
    #pH year data is one behind report year
    monthly_min_report_year <- indicator_data |> filter(Year == report_year - 1) |>
      summarise(Value = min(Value, na.rm = TRUE)) |> signif(3) 
    monthly_max_report_year <- indicator_data |> filter(Year == report_year - 1) |>
      summarise(Value = max(Value, na.rm = TRUE)) |> signif(3) 
    tmp_caption <- paste(as.character(report_year - 1), "Range")
  } else{
    #for all other indicators, use report year
    monthly_min_report_year <- indicator_data |> filter(Year == report_year) |>
      summarise(Value = min(Value, na.rm = TRUE)) |> signif(3) 
    monthly_max_report_year <- indicator_data |> filter(Year == report_year) |>
      summarise(Value = max(Value, na.rm = TRUE)) |> signif(3)
    tmp_caption <- paste(as.character(report_year), "Range")
  }
  
  #the "\u2013" here is the unicode m-dash
  valueBox(value = paste(monthly_min_report_year, "\u2013", monthly_max_report_year), color = pal[1], caption = tmp_caption)
})
```

### Long-Term Range

```{r}

#build and render value box - range pre-report year
renderValueBox({
  
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  # Monthly min & max for report year
  if (input$indicator == "pH"){
    # Monthly min & max for previous years
    #pH year data is one behind report year
    monthly_min_PrevYrs <- indicator_data |> filter(Year < (report_year - 1)) |>
      summarise(Value = min(Value, na.rm = TRUE)) |> signif(3) 
    monthly_max_PrevYrs <- indicator_data |> filter(Year < (report_year - 1)) |>
      summarise(Value = max(Value, na.rm = TRUE)) |> signif(3) 
  } else{
    # Monthly min & max for previous years
    #for all other indicators, use report year
    monthly_min_PrevYrs <- indicator_data |> filter(Year < report_year) |>
      summarise(Value = min(Value, na.rm = TRUE)) |> signif(3) 
    monthly_max_PrevYrs <- indicator_data |> filter(Year < report_year) |>
      summarise(Value = max(Value, na.rm = TRUE)) |> signif(3)  
  }

  #the "\u2013" here is the unicode m-dash
  valueBox(value = paste(monthly_min_PrevYrs, "\u2013", monthly_max_PrevYrs), color = pal[1])
})
```

Row
-----------------------------------------------------------------------

```{r}

#build indicator description
Indicator_Description <- reactive({
  indicator_desc <- indicator_data |> filter(ID == input$indicator)
  includeMarkdown(path = here('Descriptions', paste(indicator_desc$ID[1], '_description.md', sep = '')))
})

#render indicator description
renderUI({Indicator_Description()}) 

```